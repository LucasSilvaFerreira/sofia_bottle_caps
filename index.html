<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Code Holographic Gallery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Include the html5-qrcode library -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    /* [Your CSS styles here, including embedded Base64 images for the foil texture and mask] */
  </style>
</head>
<body>

  <h1>QR Code Holographic Gallery</h1>
  <div id="buttons">
    <button id="scan-button">Scan QR Code</button>
    <button id="gallery-button">View Gallery</button>
    <button id="reset-button">Reset Progress</button>
  </div>
  <div id="content">
    <!-- The QR scanner or gallery will be displayed here -->
  </div>
  <div id="progress">Loading images...</div>

  <script>
    // Number of total images
    let TOTAL_IMAGES = 0;

    // Placeholder images (will be filled dynamically)
    let imagePlaceholders = [];

    // Arrays to store scanned QR codes and assigned images
    let scannedCodes = [];
    let assignedImages = [];
    let allImagesCollected = false;

    // Get references to buttons and content area
    const scanButton = document.getElementById('scan-button');
    const galleryButton = document.getElementById('gallery-button');
    const resetButton = document.getElementById('reset-button');
    const contentDiv = document.getElementById('content');
    const progressDiv = document.getElementById('progress');

    // Event listeners for buttons
    scanButton.addEventListener('click', startScan);
    galleryButton.addEventListener('click', showGallery);
    resetButton.addEventListener('click', resetGallery);

    let html5QrCode;

    // Fetch images from cards.json
    async function fetchImages() {
      const jsonUrl = 'images/cards.json';

      try {
        const response = await fetch(jsonUrl);
        if (!response.ok) {
          throw new Error('Failed to fetch images from cards.json');
        }
        const data = await response.json();

        // Construct image URLs
        imagePlaceholders = data.map(filename => 'images/cards/' + filename);

        TOTAL_IMAGES = imagePlaceholders.length;
        loadProgress();
        updateProgress();
      } catch (error) {
        console.error('Error fetching images:', error);
        progressDiv.textContent = 'Failed to load images.';
      }
    }

    // Start the QR code scanner
    function startScan() {
      contentDiv.innerHTML = '<div id="qr-reader" style="width: 100%;"></div>';
      html5QrCode = new Html5Qrcode("qr-reader");

      const qrCodeSuccessCallback = (decodedText, decodedResult) => {
        // Handle the result here.
        onScanSuccess(decodedText, decodedResult);
        // Once a code is successfully scanned, stop scanning
        html5QrCode.stop().then(ignore => {
          // QR Code scanning is stopped.
        }).catch(err => {
          // Stop failed, handle it.
          console.error('Unable to stop scanning', err);
        });
      };

      const config = { fps: 10, qrbox: { width: 250, height: 250 } };

      // Start scanning.
      html5QrCode.start(
        { facingMode: "environment" },
        config,
        qrCodeSuccessCallback
      ).catch(err => {
        // Start failed, handle it.
        console.error('Unable to start scanning', err);
        alert('Unable to access the camera. Please allow camera permissions.');
      });
    }

    // Show the gallery
    function showGallery() {
      contentDiv.innerHTML = '<div id="gallery"></div>';
      updateGallery();
    }

    // Handle successful scan
    function onScanSuccess(decodedText, decodedResult) {
      if (!scannedCodes.includes(decodedText)) {
        // New QR code scanned
        scannedCodes.push(decodedText);
        let imageNumber = scannedCodes.length;
        if (imageNumber <= TOTAL_IMAGES) {
          assignedImages.push(imagePlaceholders[imageNumber - 1]);
          updateProgress();
          saveProgress();
          showCollectAnimation(imageNumber);
        } else {
          // All images have been collected
          if (!allImagesCollected) {
            allImagesCollected = true;
            alert('Congratulations! You have collected all images.');
          }
        }
      } else {
        // QR code already scanned; do nothing or provide a subtle indication
        console.log('QR code already scanned.');
      }
    }

    // Update the progress indicator
    function updateProgress() {
      let count = assignedImages.length;
      progressDiv.textContent = `${count}/${TOTAL_IMAGES} images discovered`;
    }

    // Update the gallery with discovered images
    function updateGallery() {
      let gallery = document.getElementById('gallery');
      gallery.innerHTML = ''; // Clear existing images
      assignedImages.forEach(src => {
        // Create card element
        let card = document.createElement('div');
        card.classList.add('card');
        card.style.backgroundImage = `url(${src})`;

        // Create glare and shine elements
        let glare = document.createElement('div');
        glare.classList.add('card__glare');
        let shine = document.createElement('div');
        shine.classList.add('card__shine');

        // Append glare and shine to card
        card.appendChild(glare);
        card.appendChild(shine);

        // Add event listeners for holographic effect
        card.addEventListener('pointermove', handlePointerMove);
        card.addEventListener('touchmove', handlePointerMove);
        card.addEventListener('mouseleave', handlePointerLeave);
        card.addEventListener('touchend', handlePointerLeave);

        gallery.appendChild(card);
      });
    }

    // Handle pointer move for holographic effect
    function handlePointerMove(e) {
      // [Your existing code for handling pointer movements]
    }

    // Handle pointer leave for holographic effect
    function handlePointerLeave(e) {
      // [Your existing code for handling pointer leave]
    }

    // Show animation when a new card is collected
    function showCollectAnimation(imageNumber) {
      // Optionally, implement a custom animation
      alert(`You have collected a new card! (${imageNumber}/${TOTAL_IMAGES})`);
      // Redirect to the gallery
      showGallery();
    }

    // Save progress to localStorage
    function saveProgress() {
      localStorage.setItem('scannedCodes', JSON.stringify(scannedCodes));
      localStorage.setItem('assignedImages', JSON.stringify(assignedImages));
    }

    // Load progress from localStorage
    function loadProgress() {
      const savedScannedCodes = JSON.parse(localStorage.getItem('scannedCodes')) || [];
      const savedAssignedImages = JSON.parse(localStorage.getItem('assignedImages')) || [];

      // Ensure that saved assigned images correspond to current image placeholders
      assignedImages = savedAssignedImages.filter(src => imagePlaceholders.includes(src));
      scannedCodes = savedScannedCodes.slice(0, assignedImages.length);

      updateProgress();
    }

    // Reset the gallery and clear saved data
    function resetGallery() {
      if (confirm('Are you sure you want to reset the progress? This will remove all collected cards.')) {
        scannedCodes = [];
        assignedImages = [];
        allImagesCollected = false;
        saveProgress();
        updateProgress();
        contentDiv.innerHTML = ''; // Clear the content area
        alert('Progress has been reset.');
      }
    }

    // Fetch images on page load
    window.onload = () => {
      fetchImages();
    };
  </script>
</body>
</html>
